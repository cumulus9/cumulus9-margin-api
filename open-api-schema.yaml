openapi: '3.0.0'
info:
    version: 'v1.0'
    title: 'Cumulus9 Margin API'
    description: |
        The Cumulus9 Margin API lets you build margin analytics integrations. Our API follows a [resource-oriented](https://en.wikipedia.org/wiki/Resource-oriented_architecture) architecture with predictable [REST API](https://en.wikipedia.org/wiki/Representational_state_transfer) URLs, making use of standard HTTP verbs, and response codes.
        ###### Getting Started
        - Use your API Key as a Bearer token for all API calls.
tags:
    - name: margin
      description: Margin requirements calculation
servers:
    - url: '{{baseUrl}}'
      description: Resource Server
paths:
    /portfolios:
        post:
            summary: Calculate portfolio margin
            description: Calculate the margin requirements for multi-account and multi-exchange portfolios.
            operationId: calculateMargin
            tags:
                - margin
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/portfolios'
            responses:
                '200':
                    $ref: '#/components/responses/results'
                '400':
                    $ref: '#/components/responses/badRequestError'
                '401':
                    $ref: '#/components/responses/unauthorizedError'
                '500':
                    $ref: '#/components/responses/internalServerError'
components:
    schemas:
        portfolios:
            description: Portfolio payload, multi-account positions.
            type: object
            required:
                - portfolio
            properties:
                calculation_type:
                    description: Calculation modes. Supported values are `margins`, `analytics`, `simm`, `all` (default `all`). Combinations are supported, e.g. `margins,analytics`.
                    type: string
                    pattern: '^(all|margins|analytics|simm)(,(margins|analytics|simm))*$'
                    default: all
                    example: margins
                execution_mode:
                    type: string
                    enum:
                        - sync
                        - async
                    default: sync
                    example: sync
                vendor_symbology:
                    type: string
                    enum:
                        - clearing
                        - ion
                        - bloomberg
                        - gmi
                        - tt_new
                    default: clearing
                    example: clearing
                cme_symbology:
                    type: string
                    enum:
                        - clearing
                        - globex
                    default: clearing
                    example: clearing
                currency_code:
                    description: Currency for the aggregate multi-currency results. The international 3-letter currency code, as defined by the ISO 4217 standard.
                    type: string
                    default: USD
                    example: USD
                use_closest_match:
                    description: Allow the system to find and use the closest match contract e.g. for incorrect expiry or strike.
                    type: boolean
                    default: true
                    example: true
                bdate:
                    description: Calculation date in format YYYYMMDD. Defaults to the latest date.
                    type: string
                    pattern: '^\d{8}$'
                    example: '20250107'
                request_id:
                    description: User-defined UUID. If omitted, a random UUID is generated.
                    type: string
                    format: uuid
                    example: '5c09862d-8d69-0f8d-821b-47762ef06a6f'
                pnl_details:
                    description: Historical P&L details. To create cache data for the entire P&L vector.
                    type: boolean
                    default: false
                    example: false
                in_memory:
                    description: Process request using in-memory mode when enabled.
                    type: boolean
                    default: false
                    example: false
                risk_metrics:
                    description: Analytics configuration object. Used when `calculation_type` includes `analytics`.
                    type: object
                    properties:
                        lookback:
                            type: integer
                            example: 1000
                        ci:
                            type: number
                            example: 99
                        method:
                            type: string
                            enum:
                                - expected-shortfall
                                - value-at-risk
                            example: expected-shortfall
                        mpor:
                            type: integer
                            example: 1
                        mode:
                            type: string
                            enum:
                                - absolute
                                - relative
                            example: absolute
                        bond_pricing_version:
                            type: integer
                            example: 2
                        bond_use_continuous_compounding:
                            type: boolean
                            example: true
                    additionalProperties: true
                simm_metrics:
                    description: SIMM calculation configuration object. Used when `calculation_type` includes `simm`.
                    type: object
                    properties:
                        version:
                            type: string
                            description: SIMM version using underscore instead of dots (for example `2_6_5`).
                            example: '2_6_5'
                        holding_period:
                            type: integer
                            enum:
                                - 1
                                - 10
                            example: 10
                    additionalProperties: true
                stress_sensitivities:
                    description: Stress sensitivities configuration object. Optional, used when `calculation_type` includes `analytics`.
                    type: object
                    properties:
                        underlying_shocks:
                            type: array
                            items:
                                type: number
                            example:
                                - -0.2
                                - -0.1
                                - -0.05
                                - -0.01
                                - 0.01
                                - 0.05
                                - 0.1
                                - 0.2
                        volatility_shock:
                            type: array
                            items:
                                type: number
                            example:
                                - 0
                                - 0
                                - 0
                                - 0
                                - 0
                                - 0
                                - 0
                                - 0
                    additionalProperties: true
                portfolio:
                    type: array
                    items:
                        type: object
                        required:
                            - account_code
                            - exchange_code
                            - contract_code
                            - contract_type
                            - contract_expiry
                            - net_position
                        properties:
                            account_code:
                                description: An internal reference of the portfolio's account.
                                type: string
                                example: Account ABC
                            exchange_code:
                                description: The exchange acronym, associated with the contract.
                                type: string
                                example: ICE.EU
                            contract_code:
                                description: The contract reference code.
                                type: string
                                example: B
                            contract_type:
                                description: Contract type, one of future (FUT), call option (CALL) or put option (PUT).
                                type: string
                                enum:
                                    - FUT
                                    - CALL
                                    - PUT
                                example: FUT
                            contract_expiry:
                                description: The expiry date of the contract.
                                type: string
                                example: '202512'
                            contract_strike:
                                description: The option strike, applicable to the CALL or PUT contract types only.
                                type: string
                                default: ''
                            net_position:
                                description: The position's size.
                                type: string
                                example: '1000'
                            account_type:
                                description: Margin account clasification.
                                type: string
                                enum:
                                    - H
                                    - S
                                default: H
                                example: H
            additionalProperties:
                description: Additional optional parameters.
                type: object
                additionalProperties: true
        portfolioResults:
            description: Detailed margin results and breakdown for a single portfolio.
            type: object
            properties:
                request_id:
                    description: UUID.
                    type: string
                    example: '5c09862d8d690f8d821b47762ef06a6f'
                portfolio_id:
                    description: UUID.
                    type: string
                    example: 'ca6b921c04f6afa9e35608d61a0223b3'
                username:
                    description: The username associated with the API credentials.
                    type: string
                    example: '@cumulus9.com'
                submitted_time:
                    description: Time at which the portfolio was submitted for margin calculation.
                    type: string
                    format: date-time
                    example: '2025-01-03 09:31:14.795795'
                account_code:
                    description: An internal reference of the portfolio's account.
                    type: string
                    example: Account ABC
                price_date:
                    description: Calculation date in format YYYYMMDD.
                    type: integer
                    example: 20250107
                currency_code:
                    description: Currency for the aggregate multi-currency results. The international 3-letter currency code, as defined by the ISO 4217 standard.
                    type: string
                    example: USD
                initial_margin:
                    description: The calculated margin requirements of the submitted portfolio.
                    type: number
                    example: 4698720
                option_liquidation_value:
                    description: The option liquidation value.
                    type: number
                    example: 0
                value_at_risk:
                    description: The portfolio's Value-at-Risk based on 1-day time horizon and 250-day lookback period.
                    type: number
                    example: 5125222
                stress_loss:
                    description: The portfolios worst daily loss over the past 250 days.
                    type: number
                    example: 5839073
                additional_margin:
                    description: Margin add-ons, if applicable e.g. liquidity or concentration charges.
                    type: number
                    example: 0
                margin_by_ccp:
                    description: Margin results broken down by CCP.
                    type: array
                    items:
                        type: object
                        properties:
                            clearing_org:
                                description: The clearing organisation code.
                                type: string
                                example: CME
                            result_type:
                                description: Margin model.
                                type: string
                                example: span2
                            currency_code:
                                description: The international 3-letter currency code, as defined by the ISO 4217 standard.
                                type: string
                                example: USD
                            fxrate:
                                description: The FX rate used to convert the multi-currency results into the base currency, USD.
                                type: number
                                example: 1.0
                            initial_margin:
                                description: The calculated margin requirements of the specific clearing house.
                                type: number
                                example: 1471104.47
                            option_liquidation_value:
                                description: The option liquidation value of the specific clearing house.
                                type: number
                                example: 0
                            cross_model_offset:
                                type: number
                                example: -67562.73
                margin_by_contract:
                    description: Margin results broken down by contract.
                    type: array
                    items:
                        type: object
                        properties:
                            clearing_org:
                                description: The clearing organisation code.
                                type: string
                                example: CME
                            result_type:
                                description: Margin model.
                                type: string
                                example: span2
                            exchange:
                                description: The exchange code.
                                type: string
                                example: CME
                            cc_code:
                                description: The contract symbol.
                                type: string
                                example: NY-BZ
                            cc_name:
                                description: The contract name.
                                type: string
                                example: Brent Crude Oil
                            sector:
                                description: The contract sector.
                                type: string
                                example: Energy
                            sub_sector:
                                description: The contract sub-sector.
                                type: string
                                example: Oil
                            currency_code:
                                description: The international 3-letter currency code, as defined by the ISO 4217 standard.
                                type: string
                                example: USD
                            fxrate:
                                description: The FX rate used to convert the multi-currency results into the base currency, USD.
                                type: number
                                example: 1.0
                            initial_margin:
                                description: The calculated margin requirements of the specific contract.
                                type: number
                                example: 1471104.47
                            option_liquidation_value:
                                description: The option liquidation value of the specific contract.
                                type: number
                                example: 0
                margin_by_span:
                    description: SPAN margin results by contract.
                    type: array
                    items:
                        type: object
                        properties:
                            result_type:
                                description: Margin model.
                                type: string
                                example: span
                            clearing_org:
                                description: The clearing organisation code.
                                type: string
                                example: CME
                            exchange:
                                description: The exchange code.
                                type: string
                                example: CME
                            scenario:
                                description: The SPAN scenario number.
                                type: string
                                example: '13'
                            cc_code:
                                description: The contract symbol.
                                type: string
                                example: NY-BZ
                            cc_name:
                                description: The contract name.
                                type: string
                                example: Brent Crude Oil
                            currency_code:
                                description: The international 3-letter currency code, as defined by the ISO 4217 standard.
                                type: string
                                example: USD
                            initial_margin:
                                description: The calculated margin requirements of the specific contract.
                                type: number
                                example: 1471104.47
                            scanning_risk:
                                description: The scanning risk component of the SPAN calculation.
                                type: number
                                example: 1471104.47
                            prompt_date_charge:
                                description: The prompt date charge component of the SPAN calculation.
                                type: number
                                example: 0
                            intra_spread_charge:
                                description: The intra-spread charge component of the SPAN calculation.
                                type: number
                                example: 0
                            short_option_charge:
                                description: The short option charge component of the SPAN calculation.
                                type: number
                                example: 0
                            intercontract_credit:
                                description: The inter-contract credit component of the SPAN calculation.
                                type: number
                                example: 0
                            strategy_spread_charge:
                                description: The strategy spread charge component of the SPAN calculation.
                                type: number
                                example: 0
                            option_liquidation_value:
                                description: The option liquidation value of the specific contract.
                                type: number
                                example: 0
                exceptions:
                    description: Provides a list of exceptions such as the positions that were not included in the calculations.
                    type: array
                    items:
                        type: object
                        properties:
                            position_id:
                                type: string
                                example: '5'
                            engine:
                                type: string
                                example: validation
                            exception:
                                type: string
                                example: 'Invalid `expiry` on position ICE.EU | B - Brent Crude Futures | FUT | 202501 | 0'
                closest_matches:
                    description: Provides a list of positions that were updated in the calculations, if the use_closest_match parameter was set to true.
                    type: array
                    items:
                        type: object
                        properties:
                            position_id:
                                type: string
                                example: '5'
                            engine:
                                type: string
                                example: validation
                            exception:
                                type: string
                                example: 'Applied closest matching expiry instead of loaded 202501 on position ICE.EU | B - Brent Crude Futures | FUT | 20250300 | 0'
            additionalProperties:
                description: Additional optional properties.
                type: object
                additionalProperties: true
        results:
            description: Margin requirement results of the submitted portfolios.
            type: object
            properties:
                request_id:
                    description: UUID.
                    type: string
                    example: '5c09862d8d690f8d821b47762ef06a6f'
                username:
                    description: The username associated with the API credentials.
                    type: string
                    example: '@cumulus9.com'
                data:
                    description: Margin results per portfolio.
                    type: array
                    items:
                        $ref: '#/components/schemas/portfolioResults'
                runtime:
                    description: Runtime of the request in milliseconds.
                    type: integer
                    example: 114
                parameters:
                    description: Margin models parameters.
                    type: object
                    additionalProperties:
                        description: Optional parameters.
                        type: object
                        additionalProperties: true
                    example:
                        span:
                            ICE: '20250106'
                            LME: '20250106'
        badRequestError:
            description: Bad Request (400) error message
            type: object
            properties:
                error:
                    type: string
                    example: Invalid request body
        unauthorizedError:
            description: Unauthorized (401) error message
            type: object
            properties:
                error:
                    type: object
                    properties:
                        message:
                            type: string
                            example: 'AWS Cognito: JWSInvalid rejection'
        internalServerError:
            description: Internal Server (500) error message
            type: object
            properties:
                error:
                    type: string
                    example: Internal Server Error
    responses:
        results:
            description: Successful response
            content:
                application/json:
                    schema:
                        $ref: '#/components/schemas/results'
        badRequestError:
            description: Bad Request (400) error
            content:
                application/json:
                    schema:
                        $ref: '#/components/schemas/badRequestError'
        unauthorizedError:
            description: Unauthorized (401) error
            content:
                application/json:
                    schema:
                        $ref: '#/components/schemas/unauthorizedError'
        internalServerError:
            description: Internal Server (500) error
            content:
                application/json:
                    schema:
                        $ref: '#/components/schemas/internalServerError'
    securitySchemes:
        bearerAuth:
            type: http
            scheme: bearer
            description: API Key provided as a Bearer token in the Authorization header.
security:
    - bearerAuth: []
